name: Deploy Laravel to GitHub Pages

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: sqlite, pdo_sqlite, mbstring, xml, ctype, iconv, tokenizer, json
        coverage: none
        
    - name: Setup Node.js 20  # ðŸ”¥ UPGRADE KE NODE 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'  # ðŸ”¥ GANTI DARI 18 KE 20
        cache: 'npm'
        
    - name: Clean NPM cache and reinstall
      run: |
        # Hapus node_modules dan package-lock.json untuk menghindari bug npm
        rm -rf node_modules
        rm -f package-lock.json
        npm cache clean --force
        
    - name: Install NPM dependencies fresh
      run: npm ci --no-audit --prefer-offline
        
    - name: Setup SQLite Database
      run: |
        mkdir -p database
        touch database/cpns_exam.sqlite
        echo "SQLite database created"
        
    - name: Copy Environment File
      run: |
        cp .env.example .env
        echo "APP_ENV=production" >> .env
        echo "APP_DEBUG=false" >> .env
        echo "DB_CONNECTION=sqlite" >> .env
        
    - name: Install Composer Dependencies
      run: composer install --no-dev --optimize-autoloader --no-interaction
        
    - name: Generate App Key
      run: php artisan key:generate
      
    - name: Build Frontend Assets
      run: |
        # Cek Node.js version
        node --version
        npm --version
        # Build dengan force
        npm run build || npm run dev
      
    - name: Run Database Migrations
      run: php artisan migrate --force
      
    - name: Cache Config
      run: |
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
        
    - name: Create Static Deployment Structure
      run: |
        # Buat folder untuk static assets
        mkdir -p public/dist
        # Copy semua assets ke folder dist
        cp -r public/* public/dist/ 2>/dev/null || true
        
        # Buat simple index.html untuk redirect
        echo '<!DOCTYPE html>
        <html>
        <head>
            <title>CPNS CAT System</title>
            <meta http-equiv="refresh" content="0; url=/dist/index.php">
            <script>
                window.location.href = "/dist/index.php";
            </script>
        </head>
        <body>
            <p>Redirecting to <a href="/dist/index.php">CPNS CAT System</a></p>
        </body>
        </html>' > public/index.html
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './public'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4