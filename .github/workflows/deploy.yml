name: Deploy Laravel to GitHub Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: sqlite, pdo_sqlite
        coverage: none
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Copy .env
      run: |
        cp .env.example .env
        echo "APP_ENV=production" >> .env
        echo "APP_DEBUG=false" >> .env
        echo "DB_CONNECTION=sqlite" >> .env
        
    - name: Create SQLite database
      run: |
        mkdir -p database
        touch database/cpns_exam.sqlite
        chmod 755 database/cpns_exam.sqlite
        
    - name: Install Composer dependencies
      run: |
        composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
        
    - name: Install NPM dependencies
      run: npm ci
      
    - name: Build assets
      run: npm run build
      
    - name: Generate application key
      run: php artisan key:generate
      
    - name: Run migrations
      run: |
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
        php artisan migrate --force
        
    - name: Build for static deployment
      run: |
        # Create dist folder
        mkdir -p public/dist
        
        # Copy all public assets to dist folder
        cp -r public/* public/dist/ || true
        
        # Create redirect files
        echo '<!DOCTYPE html>
        <html>
        <head>
            <title>Redirecting...</title>
            <script>
                sessionStorage.redirect = location.href;
            </script>
            <meta http-equiv="refresh" content="0;URL='"'"'/dist/'"'"'">
        </head>
        <body>
        </body>
        </html>' > public/index.html
        
        echo '<!DOCTYPE html>
        <html>
        <head>
            <title>Redirecting...</title>
            <script>
                const redirect = sessionStorage.redirect;
                delete sessionStorage.redirect;
                if (redirect && redirect != location.href) {
                    history.replaceState(null, null, redirect);
                }
            </script>
            <meta http-equiv="refresh" content="0;URL='"'"'/dist/'"'"'">
        </head>
        <body>
        </body>
        </html>' > public/404.html
        
    - name: Setup GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './public'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      if: github.ref == 'refs/heads/main'